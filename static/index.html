<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutri AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.6;
        }

        /* Header Navigation */
        .header {
            background-color: #ffffff;
            border-bottom: 2px solid #000000;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 4rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .cart-container {
            position: relative;
            cursor: pointer;
            padding: 0.8rem;
            border: 2px solid #000000;
            border-radius: 5px;
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        .cart-container:hover {
            background-color: #f5f5f5;
        }

        .cart-icon {
            font-size: 1.5rem;
            color: #000000;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Cart Modal */
        .cart-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .cart-modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 20px;
            border: 2px solid #000000;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            max-height: 80%;
            overflow-y: auto;
        }

        .cart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffeb3b;
        }

        .cart-modal-title {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .cart-close {
            color: #000000;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
        }

        .cart-close:hover {
            color: #ff4444;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .cart-item-info {
            flex-grow: 1;
        }

        .cart-item-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .cart-item-details {
            color: #666;
            font-size: 0.9rem;
        }

        .cart-item-price {
            font-weight: bold;
            color: #ff6600;
            font-size: 1.1rem;
            margin-right: 15px;
        }

        .cart-item-remove {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .cart-item-remove:hover {
            background-color: #cc0000;
        }

        .cart-summary {
            border-top: 2px solid #ffeb3b;
            padding-top: 15px;
            margin-top: 20px;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .cart-nutrition {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .nutrition-item {
            text-align: center;
            padding: 8px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .cart-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .cart-clear-btn {
            background-color: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .cart-clear-btn:hover {
            background-color: #444;
        }

        .cart-empty {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .header-logo {
            height: 60px;
            width: auto;
        }

        .nav-link {
            padding: 0.8rem 2rem;
            text-decoration: none;
            color: #000000;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid transparent;
            border-radius: 5px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link.active {
            background-color: #ffeb3b;
            color: #000000;
            border-color: #000000;
        }

        .nav-link:hover {
            background-color: #f5f5f5;
        }

        /* Main Content */
        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem 4rem;
        }

        /* Section Styles */
        .section {
            display: none;
            margin-bottom: 2rem;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #ffeb3b;
        }

        /* Home Section */
        .hero-section {
            background-image: url('/static/assets/main_img.jpeg');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            padding: 2rem 4rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 3rem;
            aspect-ratio: 16/9;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            min-height: 600px;
        }

        .hero-section h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #000000;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
        }

        .hero-section p {
            font-size: 1.2rem;
            color: #000000;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .hero-section p {
            font-size: 1.2rem;
        }

        .about-section {
            background-color: #f9f9f9;
            padding: 2rem 4rem;
            border-radius: 15px;
            border: 1px solid #ddd;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        .about-section h2 {
            margin-bottom: 1rem;
            color: #000000;
            font-size: 1.5rem;
        }

        .about-section p {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        /* User Section */
        .calculator-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #ffeb3b;
        }

        .save-button {
            background-color: #f44336;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .save-button:hover {
            background-color: #d32f2f;
        }

        .result-section {
            background-color: #f9f9f9;
            padding: 2rem;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .result-item {
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #000000;
        }

        .result-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        /* Order Section */
        .daily-meals-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .meal-time-section {
            background-color: #f9f9f9;
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .meal-time-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ffeb3b;
            text-align: center;
        }

        .meal-time-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .daily-summary {
            background-color: #f0f8ff;
            padding: 2rem;
            border-radius: 10px;
            border: 1px solid #ddd;
            margin-bottom: 2rem;
        }

        .progress-container {
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .action-buttons .recommend-button {
            flex: 1;
            max-width: 300px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            position: relative;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .cooking-method-select {
            margin-left: 0.5rem;
            padding: 0.3rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.8rem;
            min-width: 150px;
            max-width: 200px;
        }

        .meal-item-expanded {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .meal-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .meal-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .meal-summary-item {
            background-color: #ffffff;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            border-left: 4px solid #ffeb3b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meal-summary-info {
            flex: 1;
        }

        /* Loading indicator */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ffeb3b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .budget-recommendation-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 0.5rem;
        }

        .loading-text {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        .meal-summary-stats {
            font-size: 0.9rem;
            color: #666;
        }

        .order-panel {
            background-color: #f9f9f9;
            padding: 2rem;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ffeb3b;
        }

        .meal-category {
            margin-bottom: 1.5rem;
        }

        .meal-category h4 {
            margin-bottom: 0.5rem;
            color: #000000;
        }

        .meal-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #ffffff;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .meal-checkbox {
            margin-right: 1rem;
        }

        .meal-info {
            flex: 1;
        }

        .meal-name {
            font-weight: bold;
        }

        .meal-details {
            font-size: 0.8rem;
            color: #666;
        }

        .quantity-input {
            width: 60px;
            padding: 0.3rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-left: 1rem;
        }

        .budget-input {
            margin-bottom: 1rem;
        }

        .budget-input input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .recommend-button {
            background-color: #ffeb3b;
            color: #000000;
            padding: 0.8rem 1.5rem;
            border: 2px solid #000000;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .recommend-button:hover {
            background-color: #fff176;
        }

        .order-result {
            background-color: #f9f9f9;
            padding: 2rem;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .order-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .summary-item {
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem 2rem;
            }

            .calculator-section,
            .order-content {
                grid-template-columns: 1fr;
            }

            .nav-container {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 0 2rem;
            }

            .nav-links {
                gap: 1rem;
                order: 2;
            }

            .header-logo {
                height: 50px;
                order: 1;
            }

            .hero-section {
                padding: 1rem 2rem;
                min-height: 300px;
                aspect-ratio: 16/9;
            }

            .hero-section h1 {
                font-size: 2rem;
            }

            .about-section {
                padding: 1rem 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="header">
        <nav class="nav-container">
            <img src="/static/assets/logo.jpeg" alt="Nutri AI Logo" class="header-logo">
            <div class="nav-links">
                <a href="#" class="nav-link active" data-section="home">Trang chủ</a>
                <a href="#" class="nav-link" data-section="user">Người dùng</a>
                <a href="#" class="nav-link" data-section="order">Lên thực đơn</a>
            </div>
            <div class="cart-container" onclick="toggleCart()">
                <span class="cart-icon">🛒</span>
                <span class="cart-count" id="cartCount">0</span>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Section -->
        <section id="home" class="section active">
            <div class="hero-section">
            </div>
            
            <div class="about-section">
                <h2>About Us</h2>
                <p>
                    NutriAI mang đến giải pháp ăn uống lành mạnh được cá nhân hóa bằng trí tuệ nhân tạo. Chúng tôi giúp bạn dễ dàng lựa chọn thực đơn phù hợp, cân bằng dinh dưỡng và kiểm soát calo một cách khoa học.
                <br>
                <p>
                    Nếu bạn đang tìm kiếm một công cụ thông minh để đồng hành trong hành trình sống healthy tại Việt Nam, NutriAI là lựa chọn đáng tin cậy. Với thực đơn gợi ý đa dạng và được thiết kế riêng cho từng mục tiêu, bạn sẽ luôn có bữa ăn ngon miệng mà vẫn khỏe mạnh mỗi ngày.
                </p>
                </p>
            </div>
        </section>

        <!-- User Section -->
        <section id="user" class="section">
            <h1 class="section-title">Hồ sơ người dùng</h1>
            
            <div class="calculator-section">
                <div>
                    <h3>Tính toán nhu cầu dinh dưỡng</h3>
                    <form id="userProfileForm">
                        <div class="input-group">
                            <label for="name">Tên:</label>
                            <input type="text" id="name" name="name" value="Xuan Diem" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="age">Tuổi:</label>
                            <input type="number" id="age" name="age" value="21" min="16" max="100" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="gender">Giới tính:</label>
                            <select id="gender" name="gender" required>
                                <option value="female">Nữ</option>
                                <option value="male">Nam</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="height">Chiều cao (cm):</label>
                            <input type="number" id="height" name="height" value="160" min="100" max="250" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="weight">Cân nặng (kg):</label>
                            <input type="number" id="weight" name="weight" value="45" min="30" max="200" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="activity">Mức độ vận động:</label>
                            <select id="activity" name="activity" required>
                                <option value="sedentary">Ít vận động</option>
                                <option value="light">Vận động nhẹ</option>
                                <option value="moderate">Vận động vừa phải</option>
                                <option value="active">Vận động nhiều</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="goal">Mục tiêu:</label>
                            <select id="goal" name="goal" required>
                                <option value="lose">Giảm cân</option>
                                <option value="maintain">Duy trì cân nặng</option>
                                <option value="gain">Tăng cân</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="save-button">
                            💾 Lưu hồ sơ
                        </button>
                    </form>
                </div>
                
                <div class="result-section">
                    <h3>Kết quả tính toán</h3>
                    <div id="userResults">
                        <p>Vui lòng điền thông tin hồ sơ để xem mục tiêu dinh dưỡng hàng ngày của bạn.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Order Section -->
        <section id="order" class="section">
            <h1 class="section-title">Lập kế hoạch bữa ăn hàng ngày</h1>
            
            <!-- Daily Meal Selection -->
            <div class="daily-meals-container">
                <!-- Breakfast Section -->
                <div class="meal-time-section">
                    <h3 class="meal-time-title">🌅 Bữa sáng</h3>
                    <div id="breakfastMeals" class="meal-time-content">
                        <div class="loading">Đang tải danh sách món ăn...</div>
                    </div>
                </div>
                
                <!-- Lunch Section -->
                <div class="meal-time-section">
                    <h3 class="meal-time-title">☀️ Bữa trưa</h3>
                    <div id="lunchMeals" class="meal-time-content">
                        <div class="loading">Đang tải danh sách món ăn...</div>
                    </div>
                </div>
                
                <!-- Dinner Section -->
                <div class="meal-time-section">
                    <h3 class="meal-time-title">🌙 Bữa tối</h3>
                    <div id="dinnerMeals" class="meal-time-content">
                        <div class="loading">Đang tải danh sách món ăn...</div>
                    </div>
                </div>
            </div>
            
            <!-- Daily Summary and Progress -->
            <div class="daily-summary">
                <h3 class="panel-title">📋 Tổng kết hàng ngày</h3>
                <div id="dailyProgress">
                    <p>Chọn món ăn cho bữa sáng, trưa và tối để xem tổng hợp dinh dưỡng hàng ngày.</p>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="recommend-button" onclick="getDailyRecommendation()" id="dailyRecommendBtn">
                    🤖 Nhận gợi ý AI cho cả ngày
                </button>
                <button class="recommend-button" onclick="showBudgetOptimization()">
                    💰 Tối ưu ngân sách
                </button>
            </div>
            
            <!-- Budget Optimization Modal -->
            <div id="budgetModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeBudgetModal()">&times;</span>
                    <h3>💰 Tối ưu ngân sách</h3>
                    <div class="budget-input">
                        <label for="budget">Ngân sách hàng ngày (VND):</label>
                        <input type="number" id="budget" value="100000" min="50000" max="500000" step="10000">
                    </div>
                    <button class="recommend-button" onclick="optimizeBudgetMenu()" id="budgetOptimizeBtn">
                        🎯 Nhận gợi ý theo ngân sách
                    </button>
                    <div class="budget-recommendation-container">
                        <div id="budgetRecommendation">
                            <p>Nhập ngân sách của bạn và nhấn nút để nhận gợi ý thực đơn tối ưu.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="order-result">
                <h3 class="panel-title">📊 Kết quả & Gợi ý</h3>
                <div id="orderSummary">
                    <p>Hoàn thành kế hoạch bữa ăn hàng ngày để xem kết quả và gợi ý của AI.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Shopping Cart Modal -->
    <div id="cartModal" class="cart-modal">
        <div class="cart-modal-content">
            <div class="cart-modal-header">
                <h2 class="cart-modal-title">Giỏ hàng</h2>
                <button class="cart-close" onclick="toggleCart()">&times;</button>
            </div>
            <div id="cartItems" class="cart-items">
                <div class="cart-empty">
                    Giỏ hàng trống
                </div>
            </div>
            <div id="cartSummary" class="cart-summary" style="display: none;">
                <div class="cart-total">
                    <span>Tổng cộng:</span>
                    <span id="cartTotalCost">0 VND</span>
                </div>
                <div class="cart-nutrition">
                    <div class="nutrition-item">
                        <div>Calo</div>
                        <div id="cartTotalCalories">0</div>
                    </div>
                    <div class="nutrition-item">
                        <div>Protein</div>
                        <div id="cartTotalProtein">0g</div>
                    </div>
                    <div class="nutrition-item">
                        <div>Carbs</div>
                        <div id="cartTotalCarbs">0g</div>
                    </div>
                    <div class="nutrition-item">
                        <div>Chất béo</div>
                        <div id="cartTotalFat">0g</div>
                    </div>
                    <div class="nutrition-item">
                        <div>Chất xơ</div>
                        <div id="cartTotalFiber">0g</div>
                    </div>
                </div>
                <div class="cart-actions">
                    <button class="cart-clear-btn" onclick="clearCart()">Xóa hết</button>
                    <button class="cart-order-btn" onclick="placeOrder()" style="background-color: #ffeb3b; color: #000; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold;">Đặt hàng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let userProfile = null;
        let meals = {};
        let dailyMeals = {
            breakfast: { meals: [], quantities: [], methods: [] },
            lunch: { meals: [], quantities: [], methods: [] },
            dinner: { meals: [], quantities: [], methods: [] }
        };

        // Cooking method translation
        function translateCookingMethod(method) {
            const translations = {
                'boiled': 'Luộc',
                'steamed': 'Hấp',
                'raw': 'Sống/Tươi',
                'baked': 'Nướng lò',
                'grilled': 'Nướng',
                'fried': 'Chiên',
                'scrambled': 'Bác trứng',
                'plain': 'Nguyên chất',
                'spread': 'Phết',
                'drizzled': 'Rưới',
                'sautéed': 'Xào'
            };
            return translations[method] || method;
        }

        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Load meals when order section is opened
                    if (sectionId === 'order') {
                        loadMeals();
                    }
                });
            });

            // User profile form
            document.getElementById('userProfileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                calculateUserProfile();
            });

            // Initial setup
            loadMeals();
        });

        // API functions
        async function calculateUserProfile() {
            const formData = new FormData(document.getElementById('userProfileForm'));
            const userData = {
                name: formData.get('name'),
                age: parseInt(formData.get('age')),
                gender: formData.get('gender'),
                height: parseFloat(formData.get('height')),
                weight: parseFloat(formData.get('weight')),
                activity: formData.get('activity'),
                goal: formData.get('goal')
            };

            try {
                const response = await fetch('/api/user/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    throw new Error('Failed to calculate profile');
                }

                const result = await response.json();
                userProfile = result;
                displayUserResults(result);
                showSuccess('Hồ sơ đã được lưu thành công!');
            } catch (error) {
                showError('Error calculating profile: ' + error.message);
            }
        }

        function displayUserResults(result) {
            const resultsDiv = document.getElementById('userResults');
            resultsDiv.innerHTML = `
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-value">${Math.round(result.daily_calories)}</div>
                        <div class="result-label">Calo hàng ngày</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${Math.round(result.protein_target)}g</div>
                        <div class="result-label">Mục tiêu Đạm</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${Math.round(result.carb_target)}g</div>
                        <div class="result-label">Mục tiêu Tinh bột</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${Math.round(result.fat_target)}g</div>
                        <div class="result-label">Mục tiêu Chất béo tốt</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${Math.round(result.fiber_target)}g</div>
                        <div class="result-label">Mục tiêu Chất xơ</div>
                    </div>
                </div>
            `;
        }

        async function loadMeals() {
            try {
                const response = await fetch('/api/meals');
                if (!response.ok) {
                    throw new Error('Failed to load meals');
                }

                const data = await response.json();
                meals = data.categories;
                displayMealsForAllTimes();
            } catch (error) {
                showError('Lỗi khi tải danh sách món ăn: ' + error.message);
            }
        }

        function displayMealsForAllTimes() {
            const mealTimes = ['breakfast', 'lunch', 'dinner'];
            const mealTimeIds = ['breakfastMeals', 'lunchMeals', 'dinnerMeals'];
            
            mealTimes.forEach((mealTime, index) => {
                displayMealsForTime(mealTime, mealTimeIds[index]);
            });
        }

        function displayMealsForTime(mealTime, containerId) {
            const container = document.getElementById(containerId);
            let html = '';

            Object.keys(meals).forEach(categoryKey => {
                const category = meals[categoryKey];
                html += `
                    <div class="meal-category">
                        <h4>${category.name}</h4>
                        ${category.meals.map(meal => `
                            <div class="meal-item-expanded">
                                <div class="meal-header">
                                    <input type="checkbox" class="meal-checkbox" 
                                           data-meal-time="${mealTime}"
                                           data-meal='${JSON.stringify(meal)}' 
                                           onchange="toggleMealForTime(this, '${mealTime}')">
                                    <div class="meal-info">
                                        <div class="meal-name">${meal.name}</div>
                                        <div class="meal-details">${meal.calories} cal, ${meal.protein}g đạm, ${meal.carbs}g tinh bột, ${meal.fat}g chất béo tốt, ${meal.fiber}g chất xơ /100g</div>
                                    </div>
                                </div>
                                <div class="meal-controls" style="display: none;">
                                    <label>Phương pháp nấu:</label>
                                    <select class="cooking-method-select" onchange="updateMealMethod(this, '${mealTime}')">
                                        ${meal.cooking_methods && meal.cooking_methods.length > 0 ? 
                                            meal.cooking_methods.map((method, index) => 
                                                `<option value="${method.method}" ${index === 0 ? 'selected' : ''}>${translateCookingMethod(method.method)} - ${method.calories} cal, ${method.price} VND</option>`
                                            ).join('') : 
                                            '<option value="" selected>Cơ bản (per 100g)</option>'
                                        }
                                    </select>
                                    <label>Số lượng:</label>
                                    <input type="number" class="quantity-input" value="100" min="25" step="25" 
                                           onchange="updateMealQuantity(this, '${mealTime}')" placeholder="gram">
                                    <span>g</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleMealForTime(checkbox, mealTime) {
            const meal = JSON.parse(checkbox.getAttribute('data-meal'));
            const mealItem = checkbox.closest('.meal-item-expanded');
            const controls = mealItem.querySelector('.meal-controls');
            
            if (checkbox.checked) {
                controls.style.display = 'flex';
                
                // Add to daily meals
                if (!dailyMeals[mealTime].meals.includes(meal.name)) {
                    dailyMeals[mealTime].meals.push(meal.name);
                    dailyMeals[mealTime].quantities.push(100); // default 100g
                    // Set first cooking method as default if available
                    const defaultMethod = meal.cooking_methods && meal.cooking_methods.length > 0 ? 
                        meal.cooking_methods[0].method : '';
                    dailyMeals[mealTime].methods.push(defaultMethod);
                }
            } else {
                controls.style.display = 'none';
                
                // Remove from daily meals
                const index = dailyMeals[mealTime].meals.indexOf(meal.name);
                if (index > -1) {
                    dailyMeals[mealTime].meals.splice(index, 1);
                    dailyMeals[mealTime].quantities.splice(index, 1);
                    dailyMeals[mealTime].methods.splice(index, 1);
                }
            }
            
            updateDailySummary();
        }

        function updateMealMethod(select, mealTime) {
            const mealItem = select.closest('.meal-item-expanded');
            const checkbox = mealItem.querySelector('.meal-checkbox');
            const meal = JSON.parse(checkbox.getAttribute('data-meal'));
            const method = select.value;
            
            const index = dailyMeals[mealTime].meals.indexOf(meal.name);
            if (index > -1) {
                dailyMeals[mealTime].methods[index] = method;
                updateDailySummary();
            }
        }

        function updateMealQuantity(input, mealTime) {
            const mealItem = input.closest('.meal-item-expanded');
            const checkbox = mealItem.querySelector('.meal-checkbox');
            const meal = JSON.parse(checkbox.getAttribute('data-meal'));
            let quantity = parseFloat(input.value);
            
            // Round to nearest 25g increment
            quantity = Math.round(quantity / 25) * 25;
            // Ensure minimum 25g
            quantity = Math.max(25, quantity);
            
            // Update the input value to show rounded amount
            input.value = quantity;
            
            const index = dailyMeals[mealTime].meals.indexOf(meal.name);
            if (index > -1) {
                dailyMeals[mealTime].quantities[index] = quantity;
                updateDailySummary();
            }
        }

        async function updateDailySummary() {
            const progressDiv = document.getElementById('dailyProgress');
            
            // Calculate totals for each meal time
            const mealTimes = ['breakfast', 'lunch', 'dinner'];
            const mealTimeNames = ['🌅 Bữa sáng', '☀️ Bữa trưa', '🌙 Bữa tối'];
            
            let totalDailyCalories = 0;
            let totalDailyProtein = 0;
            let totalDailyCarbs = 0;
            let totalDailyFat = 0;
            let totalDailyFiber = 0;
            let totalDailyCost = 0;
            
            let summaryHtml = '';
            
            // Process each meal time
            for (let i = 0; i < mealTimes.length; i++) {
                const mealTime = mealTimes[i];
                const mealTimeName = mealTimeNames[i];
                const mealData = dailyMeals[mealTime];
                
                let mealCalories = 0;
                let mealProtein = 0;
                let mealCarbs = 0;
                let mealFat = 0;
                let mealFiber = 0;
                let mealCost = 0;
                
                if (mealData.meals.length > 0) {
                    summaryHtml += `<div class="meal-time-summary"><h4>${mealTimeName}</h4>`;
                    
                    for (let j = 0; j < mealData.meals.length; j++) {
                        const mealName = mealData.meals[j];
                        const quantity = mealData.quantities[j] || 100;
                        const method = mealData.methods[j] || '';
                        
                        // Find the meal in our data
                        let meal = null;
                        Object.values(meals).forEach(category => {
                            const foundMeal = category.meals.find(m => m.name === mealName);
                            if (foundMeal) meal = foundMeal;
                        });
                        
                        if (meal) {
                            let calories, protein, carbs, fat, fiber, cost;
                            
                            if (method && meal.cooking_methods) {
                                const cookingMethod = meal.cooking_methods.find(m => m.method === method);
                                if (cookingMethod) {
                                    // Use cooking method values (typically per serving)
                                    const servings = quantity / 100; // assume 100g per serving
                                    calories = cookingMethod.calories * servings;
                                    protein = cookingMethod.protein * servings;
                                    carbs = cookingMethod.carbs * servings;
                                    fat = cookingMethod.fat * servings;
                                    fiber = (cookingMethod.fiber || 0) * servings;
                                    cost = cookingMethod.price * servings;
                                } else {
                                    // Use base values per 100g
                                    calories = (meal.calories * quantity) / 100;
                                    protein = (meal.protein * quantity) / 100;
                                    carbs = (meal.carbs * quantity) / 100;
                                    fat = (meal.fat * quantity) / 100;
                                    fiber = ((meal.fiber || 0) * quantity) / 100;
                                    cost = (meal.price * quantity) / 100;
                                }
                            } else {
                                // Use base values per 100g
                                calories = (meal.calories * quantity) / 100;
                                protein = (meal.protein * quantity) / 100;
                                carbs = (meal.carbs * quantity) / 100;
                                fat = (meal.fat * quantity) / 100;
                                fiber = ((meal.fiber || 0) * quantity) / 100;
                                cost = (meal.price * quantity) / 100;
                            }
                            
                            mealCalories += calories;
                            mealProtein += protein;
                            mealCarbs += carbs;
                            mealFat += fat;
                            mealFiber += fiber;
                            mealCost += cost;
                            
                            const displayName = `${mealName} (${translateCookingMethod(method)})`;
                            summaryHtml += `
                                <div class="meal-summary-item">
                                    <div class="meal-summary-info">
                                        <strong>${displayName}</strong>
                                        <div class="meal-summary-stats">${Math.round(quantity)} g, ${Math.round(calories)} cal, ${Math.round(cost)} VND</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    summaryHtml += `
                        <div class="meal-time-totals">
                            <strong>Tổng bữa ăn: ${Math.round(mealCalories)} cal, ${Math.round(mealProtein)}g đạm, ${Math.round(mealCarbs)}g tinh bột, ${Math.round(mealFat)}g chất béo tốt, ${Math.round(mealFiber)}g chất xơ, ${Math.round(mealCost)} VND</strong>
                        </div>
                        </div>
                    `;
                }
                
                totalDailyCalories += mealCalories;
                totalDailyProtein += mealProtein;
                totalDailyCarbs += mealCarbs;
                totalDailyFat += mealFat;
                totalDailyFiber += mealFiber;
                totalDailyCost += mealCost;
            }
            
            // Show daily totals
            if (totalDailyCalories > 0) {
                summaryHtml += `
                    <div class="daily-totals">
                        <h3>🎯 Tổng hàng ngày</h3>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="result-value">${Math.round(totalDailyCalories)}</div>
                                <div class="result-label">Tổng Calo</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${Math.round(totalDailyProtein)}g</div>
                                <div class="result-label">Tổng Đạm</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${Math.round(totalDailyCarbs)}g</div>
                                <div class="result-label">Tổng Tinh bột</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${Math.round(totalDailyFat)}g</div>
                                <div class="result-label">Tổng Chất béo tốt</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${Math.round(totalDailyFiber)}g</div>
                                <div class="result-label">Tổng Chất xơ</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${Math.round(totalDailyCost)}</div>
                                <div class="result-label">Tổng Chi phí (VND)</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add progress bars if user profile exists
                if (userProfile) {
                    const targetCalories = userProfile.daily_calories;
                    const targetProtein = userProfile.protein_target;
                    const targetCarbs = userProfile.carb_target;
                    const targetFiber = userProfile.fiber_target;
                    
                    const calorieProgress = Math.min((totalDailyCalories / targetCalories) * 100, 100);
                    const proteinProgress = Math.min((totalDailyProtein / targetProtein) * 100, 100);
                    const carbProgress = Math.min((totalDailyCarbs / targetCarbs) * 100, 100);
                    const fiberProgress = Math.min((totalDailyFiber / targetFiber) * 100, 100);
                    
                    summaryHtml += `
                        <div class="progress-container">
                            <h4>Tiến độ đạt mục tiêu hàng ngày</h4>
                            <div class="progress-item">
                                <div class="progress-text">Calo: ${calorieProgress.toFixed(0)}% mục tiêu (${Math.round(totalDailyCalories)}/${Math.round(targetCalories)})</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${calorieProgress}%"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-text">Đạm: ${proteinProgress.toFixed(0)}% mục tiêu (${Math.round(totalDailyProtein)}g/${Math.round(targetProtein)}g)</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${proteinProgress}%"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-text">Tinh bột: ${carbProgress.toFixed(0)}% mục tiêu (${Math.round(totalDailyCarbs)}g/${Math.round(targetCarbs)}g)</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${carbProgress}%"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-text">Chất xơ: ${fiberProgress.toFixed(0)}% mục tiêu (${Math.round(totalDailyFiber)}g/${Math.round(targetFiber)}g)</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${fiberProgress}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                summaryHtml = '<p>Chọn món ăn cho bữa sáng, trưa và tối để xem tóm tắt dinh dưỡng hàng ngày.</p>';
            }
            
            progressDiv.innerHTML = summaryHtml;
        }

        async function getDailyRecommendation() {
            if (!userProfile) {
                showError('Vui lòng hoàn thành hồ sơ người dùng trước!');
                return;
            }
            
            // Check if any meals are selected
            const hasSelectedMeals = Object.values(dailyMeals).some(mealTime => mealTime.meals.length > 0);
            if (!hasSelectedMeals) {
                showError('Vui lòng chọn một số món ăn trước!');
                return;
            }
            
            const btn = document.getElementById('dailyRecommendBtn');
            const summaryDiv = document.getElementById('orderSummary');
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Đang phân tích thực đơn...';
            summaryDiv.innerHTML = '<div class="loading-text"><span class="loading-spinner"></span>AI đang phân tích thực đơn của bạn và đưa ra gợi ý cải thiện...</div>';
            
            try {
                const response = await fetch('/api/daily/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user: userProfile.user,
                        daily_meals: dailyMeals
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get daily recommendation');
                }

                const recommendation = await response.json();
                displayDailyRecommendation(recommendation);
            } catch (error) {
                showError('Lỗi khi nhận gợi ý hàng ngày: ' + error.message);
                summaryDiv.innerHTML = '<p style="color: red;">Có lỗi xảy ra khi nhận gợi ý. Vui lòng thử lại.</p>';
            } finally {
                // Reset button state
                btn.disabled = false;
                btn.innerHTML = '🤖 Nhận gợi ý AI cho cả ngày';
            }
        }

        function displayDailyRecommendation(recommendation) {
            console.log('AI Recommendation received:', recommendation);  // Debug log
            
            const summaryDiv = document.getElementById('orderSummary');
            summaryDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                    <div class="result-grid" style="margin-top: 1rem;">
                        <div class="result-item" style="background: rgba(255,255,255,0.2); color: white;">
                            <div class="result-value">${Math.round(recommendation.total_calories)}</div>
                            <div class="result-label">Calo Tối ưu</div>
                        </div>
                        <div class="result-item" style="background: rgba(255,255,255,0.2); color: white;">
                            <div class="result-value">${Math.round(recommendation.total_protein)}g</div>
                            <div class="result-label">Đạm</div>
                        </div>
                        <div class="result-item" style="background: rgba(255,255,255,0.2); color: white;">
                            <div class="result-value">${Math.round(recommendation.total_carbs)}g</div>
                            <div class="result-label">Tinh bột</div>
                        </div>
                        <div class="result-item" style="background: rgba(255,255,255,0.2); color: white;">
                            <div class="result-value">${Math.round(recommendation.total_fat)}g</div>
                            <div class="result-label">Chất béo tốt</div>
                        </div>
                        <div class="result-item" style="background: rgba(255,255,255,0.2); color: white;">
                            <div class="result-value">${Math.round(recommendation.total_fiber)}g</div>
                            <div class="result-label">Chất xơ</div>
                        </div>
                        <div class="result-item" style="background: rgba(255,255,255,0.2); color: white;">
                            <div class="result-value">${Math.round(recommendation.total_cost)}</div>
                            <div class="result-label">Chi phí (VND)</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 5px;">
                        <strong>💡 Giải thích:</strong> ${recommendation.explanation}
                    </div>
                    ${recommendation.adjusted_meals && recommendation.adjusted_meals.length > 0 ? `
                        <div style="margin-top: 1rem;">
                            <h5>🔧 Gợi ý điều chỉnh khẩu phần:</h5>
                            ${recommendation.adjusted_meals.map((meal, index) => {
                                const newQty = recommendation.adjusted_quantities[index];
                                // Convert servings back to grams for cooking methods, or display as-is for gram-based
                                const displayQty = meal.name.includes('(') ? 
                                    `${(newQty).toFixed(0)}g` :  // Cooking method: convert servings to grams
                                    `${newQty.toFixed(0)}g`;           // Base meal: already in grams
                                
                                // Check if there's a significant change (more than 10% difference)
                                const originalQty = getOriginalQuantityForMeal(meal.name);
                                const changePercent = Math.abs((newQty - originalQty) / originalQty * 100);
                                
                                if (changePercent > 10) {
                                    return `<div style="padding: 0.5rem; margin: 0.25rem 0; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                        <strong>${meal.name}:</strong> Điều chỉnh thành ${displayQty}
                                        <span style="color: #ffeb3b;">(${changePercent.toFixed(0)}% ${newQty > originalQty ? 'tăng' : 'giảm'})</span>
                                    </div>`;
                                } else {
                                    return `<div style="padding: 0.5rem; margin: 0.25rem 0; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                        <strong>${meal.name}:</strong> Giữ nguyên ${displayQty} ✓
                                    </div>`;
                                }
                            }).join('')}
                        </div>
                    ` : '<div style="margin-top: 1rem; color: #ffeb3b;">No portion adjustments needed - your current plan looks good!</div>'}
                </div>
                <div style="margin-top: 1rem; text-align: right;">
                    <button onclick="saveDailyRecommendationToCart(${JSON.stringify(recommendation).replace(/"/g, '&quot;')})" 
                            style="background: #ffeb3b; color: #000; border: none; padding: 12px 24px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                        🛒 Lưu vào giỏ hàng
                    </button>
                </div>
            `;
        }

        // Helper function to get original quantity for a meal
        function getOriginalQuantityForMeal(mealName) {
            // Extract meal name without cooking method
            const baseName = mealName.split(' (')[0];
            
            // Search through daily meals to find original quantity
            for (const mealTime of ['breakfast', 'lunch', 'dinner']) {
                const mealIndex = dailyMeals[mealTime].meals.indexOf(baseName);
                if (mealIndex !== -1) {
                    const quantity = dailyMeals[mealTime].quantities[mealIndex];
                    const method = dailyMeals[mealTime].methods[mealIndex];
                    
                    return quantity;
                }
            }
            return 100; // Default fallback
        }

        function showBudgetOptimization() {
            document.getElementById('budgetModal').style.display = 'block';
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').style.display = 'none';
        }

        async function optimizeBudgetMenu() {
            if (!userProfile) {
                showError('Vui lòng hoàn thành hồ sơ người dùng trước!');
                return;
            }

            const budget = parseFloat(document.getElementById('budget').value);
            const btn = document.getElementById('budgetOptimizeBtn');
            const recommendationDiv = document.getElementById('budgetRecommendation');
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Đang tối ưu thực đơn...';
            recommendationDiv.innerHTML = '<div class="loading-text"><span class="loading-spinner"></span>AI đang phân tích và tối ưu thực đơn theo ngân sách của bạn...</div>';
            
            try {
                const response = await fetch('/api/budget/optimize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user: userProfile.user,
                        budget: budget
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to optimize budget menu');
                }

                const menu = await response.json();
                displayBudgetRecommendation(menu);
            } catch (error) {
                showError('Lỗi khi tối ưu thực đơn: ' + error.message);
                recommendationDiv.innerHTML = '<p style="color: red;">Có lỗi xảy ra khi tối ưu thực đơn. Vui lòng thử lại.</p>';
            } finally {
                // Reset button state
                btn.disabled = false;
                btn.innerHTML = '🎯 Nhận gợi ý theo ngân sách';
            }
        }

        function displayBudgetRecommendation(menu) {
            const recommendationDiv = document.getElementById('budgetRecommendation');
            
            // Helper function to format meal details
            const formatMeal = (meal) => {
                const portions = meal.portions || meal.quantity || 100;
                const unit = 'gram';
                const methodInfo = ` (${translateCookingMethod(meal.method)})`;
                return `
                    <div style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 3px;">
                        • <strong>${meal.name}</strong>${methodInfo}<br>
                        <small style="color: #666;">
                            ${portions} ${unit} - ${Math.round(meal.calories)} calo - ${meal.protein}g đạm - ${Math.round(meal.fat)}g chất béo tốt - ${Math.round(meal.carbs)}g tinh bột - ${Math.round(meal.fiber)}g chất xơ - ${Math.round(meal.price)} VND
                        </small>
                    </div>
                `;
            };
            
            recommendationDiv.innerHTML = `
                <div style="background: white; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                    <h4>Thực đơn tối ưu trong ngày</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <div style="text-align: center; padding: 0.5rem; background: #e8f5e8; border-radius: 5px;">
                            <strong>Tổng chi phí</strong><br>
                            ${Math.round(menu.total_cost).toLocaleString()} VND
                        </div>
                        <div style="text-align: center; padding: 0.5rem; background: #fff3e0; border-radius: 5px;">
                            <strong>Tổng calo</strong><br>
                            ${Math.round(menu.total_calories)} calo
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <h5>🌅 Bữa sáng:</h5>
                        ${menu.breakfast.map(formatMeal).join('')}
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <h5>☀️ Bữa trưa:</h5>
                        ${menu.lunch.map(formatMeal).join('')}
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <h5>🌙 Bữa tối:</h5>
                        ${menu.dinner.map(formatMeal).join('')}
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 0.5rem; background: #f0f0f0; border-radius: 3px;">
                        <strong>Giải thích AI:</strong> ${menu.explanation}
                    </div>
                </div>
                <div style="margin-top: 1rem; text-align: right;">
                    <button onclick="saveBudgetMenuToCart(${JSON.stringify(menu).replace(/"/g, '&quot;')})" 
                            style="background: #ffeb3b; color: #000; border: none; padding: 12px 24px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                        🛒 Lưu vào giỏ hàng
                    </button>
                </div>
            `;
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Shopping Cart Functions
        let shoppingCart = [];

        function toggleCart() {
            const modal = document.getElementById('cartModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                loadCart();
                modal.style.display = 'block';
            }
        }

        async function loadCart() {
            try {
                const response = await fetch('/api/cart');
                const cartData = await response.json();
                displayCart(cartData);
            } catch (error) {
                console.error('Error loading cart:', error);
                showError('Lỗi khi tải giỏ hàng');
            }
        }

        function displayCart(cartData) {
            const cartItems = document.getElementById('cartItems');
            const cartSummary = document.getElementById('cartSummary');
            const cartCount = document.getElementById('cartCount');

            if (!cartData.items || cartData.items.length === 0) {
                cartItems.innerHTML = '<div class="cart-empty">Giỏ hàng trống</div>';
                cartSummary.style.display = 'none';
                cartCount.textContent = '0';
                return;
            }

            // Display cart items
            cartItems.innerHTML = cartData.items.map((item, index) => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-details">
                            ${item.cooking_method ? item.cooking_method + ' • ' : ''}${item.quantity}g
                            <br>
                            ${item.calories.toFixed(1)} cal • ${item.protein.toFixed(1)}g đạm • ${item.carbs.toFixed(1)}g tinh bột • ${item.fat.toFixed(1)}g chất béo • ${item.fiber.toFixed(1)}g chất xơ
                        </div>
                    </div>
                    <div class="cart-item-price">${item.price.toLocaleString()} VND</div>
                    <button class="cart-item-remove" onclick="removeCartItem(${index})">Xóa</button>
                </div>
            `).join('');

            // Display summary
            cartSummary.style.display = 'block';
            document.getElementById('cartTotalCost').textContent = `${cartData.total_cost.toLocaleString()} VND`;
            document.getElementById('cartTotalCalories').textContent = cartData.total_calories.toFixed(1);
            document.getElementById('cartTotalProtein').textContent = `${cartData.total_protein.toFixed(1)}g`;
            document.getElementById('cartTotalCarbs').textContent = `${cartData.total_carbs.toFixed(1)}g`;
            document.getElementById('cartTotalFat').textContent = `${cartData.total_fat.toFixed(1)}g`;
            document.getElementById('cartTotalFiber').textContent = `${cartData.total_fiber.toFixed(1)}g`;

            // Update cart count
            cartCount.textContent = cartData.items.length.toString();
        }

        async function addToCart(item) {
            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(item)
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('cartCount').textContent = result.cart_size.toString();
                    showSuccess('Đã thêm vào giỏ hàng');
                } else {
                    throw new Error('Failed to add to cart');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                showError('Lỗi khi thêm vào giỏ hàng');
            }
        }

        async function removeCartItem(index) {
            try {
                const response = await fetch(`/api/cart/item/${index}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadCart(); // Reload cart display
                    showSuccess('Đã xóa khỏi giỏ hàng');
                } else {
                    throw new Error('Failed to remove item');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                showError('Lỗi khi xóa khỏi giỏ hàng');
            }
        }

        async function clearCart() {
            if (confirm('Bạn có chắc muốn xóa hết giỏ hàng?')) {
                try {
                    const response = await fetch('/api/cart/clear', {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadCart(); // Reload cart display
                        showSuccess('Đã xóa hết giỏ hàng');
                    } else {
                        throw new Error('Failed to clear cart');
                    }
                } catch (error) {
                    console.error('Error clearing cart:', error);
                    showError('Lỗi khi xóa giỏ hàng');
                }
            }
        }

        function placeOrder() {
            console.log('Đặt hàng được nhấn - chức năng sẽ được triển khai sau');
            alert('Đơn hàng đã được đặt thành công!');
        }

        // Load cart count on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/cart');
                const cartData = await response.json();
                document.getElementById('cartCount').textContent = (cartData.items || []).length.toString();
            } catch (error) {
                console.error('Error loading cart count:', error);
            }
        });

        // Save daily recommendation to cart
        async function saveDailyRecommendationToCart(recommendation) {
            try {
                for (let i = 0; i < recommendation.adjusted_meals.length; i++) {
                    const meal = recommendation.adjusted_meals[i];
                    const quantity = recommendation.adjusted_quantities[i];
                    
                    // Calculate nutrition per serving based on quantity
                    const nutritionPerServing = calculateNutritionForQuantity(meal, quantity);
                    
                    const cartItem = {
                        name: meal.name,
                        quantity: quantity,
                        cooking_method: meal.cooking_methods && meal.cooking_methods.length > 0 ? meal.cooking_methods[0].method : null,
                        calories: nutritionPerServing.calories,
                        protein: nutritionPerServing.protein,
                        carbs: nutritionPerServing.carbs,
                        fat: nutritionPerServing.fat,
                        fiber: nutritionPerServing.fiber,
                        price: nutritionPerServing.price
                    };
                    
                    await addToCart(cartItem);
                }
                showSuccess('Đã lưu toàn bộ thực đơn vào giỏ hàng!');
            } catch (error) {
                console.error('Error saving daily recommendation to cart:', error);
                showError('Lỗi khi lưu thực đơn vào giỏ hàng');
            }
        }

        // Save budget menu to cart
        async function saveBudgetMenuToCart(menu) {
            try {
                const allMeals = [...menu.breakfast, ...menu.lunch, ...menu.dinner];
                
                for (const meal of allMeals) {
                    const quantity = meal.quantity || meal.portions || 100;
                    
                    // Calculate nutrition per serving
                    const nutritionPerServing = calculateNutritionForQuantity(meal, quantity);
                    
                    const cartItem = {
                        name: meal.name,
                        quantity: quantity,
                        cooking_method: meal.method || null,
                        calories: nutritionPerServing.calories,
                        protein: nutritionPerServing.protein,
                        carbs: nutritionPerServing.carbs,
                        fat: nutritionPerServing.fat,
                        fiber: nutritionPerServing.fiber,
                        price: nutritionPerServing.price
                    };
                    
                    await addToCart(cartItem);
                }
                showSuccess('Đã lưu thực đơn tối ưu vào giỏ hàng!');
            } catch (error) {
                console.error('Error saving budget menu to cart:', error);
                showError('Lỗi khi lưu thực đơn vào giỏ hàng');
            }
        }

        // Helper function to calculate nutrition for specific quantity
        function calculateNutritionForQuantity(meal, quantity) {
            // Check if this is from budget optimization (meal.price is already calculated correctly)
            // or from daily recommendations (need to calculate price)
            if (meal.quantity && meal.price) {
                // Budget optimization: price is already calculated for the specific quantity
                return {
                    calories: meal.calories,
                    protein: meal.protein,
                    carbs: meal.carbs,
                    fat: meal.fat,
                    fiber: meal.fiber || 0,
                    price: meal.price  // Don't multiply again!
                };
            } else {
                // Daily recommendations: calculate based on per-100g values
                const scale = quantity / 100;
                return {
                    calories: meal.calories * scale,
                    protein: meal.protein * scale,
                    carbs: meal.carbs * scale,
                    fat: meal.fat * scale,
                    fiber: (meal.fiber || 0) * scale,
                    price: meal.price * scale
                };
            }
        }
    </script>
</body>
</html>